name: Tabletop Incident Injects

on:
  schedule:
    - cron: "*/6 * * * *"  # Every 6 minutes as I believe 6 is the minimum for my free account.
  workflow_dispatch: # Allow manual enabling

permissions:
  contents: read
  issues: write

jobs:
  create_alert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read inject list
        id: read_injects
        # if injects.txt is present on workflows folder, then will read injects from it (preferred)
        # if not, will read the example injects after else. Modify as required.
        run: |
          if [ -f "injects.txt" ]; then
            mapfile -t injects < injects.txt
          else
            injects=("Suspicious login from admin account"
                     "Privilege escalation detected on web server"
                     "Email gateway reports phishing with attachment"
                     "Crowdstrike Falcon quarantined suspicious file"
                     "Azure AD conditional access bypass was attempted"
                     "Firewall rule unexpectedly changed"
                     "Data exfiltration pattern detected in proxy logs"
                     "MFA disabled by administrator account"
                     "Multiple failed logins detected from high risk country IP")
          fi
          RANDOM_INDEX=$((RANDOM % ${#injects[@]}))
          echo "inject=${injects[$RANDOM_INDEX]}" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          INJECT: ${{ steps.read_injects.outputs.inject }}
        run: |
          # Randomized fake details
          USERS=("A.Arkin" "A.Jolie" "B.Pitt" "C.Theron" "D.Washington" "E.Wood" "H.Ford" "I.Elba" "J.Aniston" "J.Lawrence" "K.Reeves" "L.DiCaprio" "M.Robbie" "N.Portman" "O.Wilson" "P.Stewart" "Q.Tarantino" "R.Gosling" "S.L.Jackson" "W.Ferrell")
          HOSTS=("BDP-SRV01" "TMX-LAP03" "TMSR-WS12" "TMCSE-AD01" "ADS-MAIL02" "TGMT-FW01" "TMCS-SQL03")
          IPS=("185.36.88.54" "92.143.21.100" "10.0.12.5" "172.16.8.9" "45.77.222.13" "212.58.124.5")

          USER=${USERS[$RANDOM % ${#USERS[@]}]}
          HOST=${HOSTS[$RANDOM % ${#HOSTS[@]}]}
          IP=${IPS[$RANDOM % ${#IPS[@]}]}
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S.%N UTC')
          RAND=$((RANDOM % 10000))

          TITLE="ðŸš¨ Security Alert #${RAND} - ${TIMESTAMP}"

          BODY="{\"title\":\"${TITLE}\",\"body\":\"**Incident:** ${INJECT}\n\n**Detected by:** SOC Monitoring\n**User:** ${USER}\n**Host:** ${HOST}\n**Source IP:** ${IP}\n**Timestamp:** ${TIMESTAMP}\n\n_Please triage and respond following IR playbook._\",\"labels\":[\"Tabletop\",\"Alert\"]}"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -d "$BODY" \
            "https://api.github.com/repos/${REPO}/issues"
