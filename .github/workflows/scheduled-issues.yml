name: Tabletop Exercise Injects

on:
  schedule:
    - cron: "*/6 * * * *"
  workflow_dispatch:
    inputs:
      reset:
        description: "Start a new random exercise? (true = new, false = continue)"
        required: true
        type: choice
        options: ["false","true"]
        default: "false"
      exercise_file:
        description: "Select an exercise file (or leave blank for random)"
        required: false
        type: choice
        options: ["", "exercise-1.txt", "exercise-2.txt", "exercise-3.txt", "exercise-4.txt", "exercise-5.txt"]
        default: ""

permissions:
  contents: write
  issues: write

jobs:
  injects:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true

      - name: Select or continue exercise file
        id: select
        run: |
          set -euo pipefail
          RESET="${{ github.event.inputs.reset }}"
          STATE_FILE="state.json"

          shopt -s nullglob
          files=(exercise-*.txt)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No exercise-*.txt files found." >&2
            exit 1
          fi

          if [ "$RESET" = "true" ] || [ ! -f "$STATE_FILE" ]; then
            USER_FILE="${{ github.event.inputs.exercise_file }}"
            if [ -n "$USER_FILE" ] && [ -f "$USER_FILE" ]; then
              RANDOM_FILE="$USER_FILE"
              echo "User-selected exercise: $RANDOM_FILE"
            else
              RANDOM_FILE=${files[RANDOM % ${#files[@]}]}
              echo "Picked random exercise: $RANDOM_FILE"
            fi

            INDEX=0
            echo "{\"current_exercise\":\"${RANDOM_FILE}\",\"index\":${INDEX},\"start_time\":\"$(date -u +'%Y-%m-%d %H:%M:%S UTC')\"}" > "$STATE_FILE"
            echo "Picked new exercise: $RANDOM_FILE"
          else
            FILE=$(jq -r .current_exercise "$STATE_FILE")
            INDEX=$(jq -r .index "$STATE_FILE")
            TOTAL=$(wc -l < "$FILE" | tr -d ' ')
            if [ "$INDEX" -ge "$TOTAL" ]; then
              USER_FILE="${{ github.event.inputs.exercise_file }}"
              if [ -n "$USER_FILE" ] && [ -f "$USER_FILE" ]; then
                RANDOM_FILE="$USER_FILE"
                echo "User-selected new exercise after completion: $RANDOM_FILE"
              else
                RANDOM_FILE=${files[RANDOM % ${#files[@]}]}
                echo "Previous exercise completed, picked new random: $RANDOM_FILE"
              fi
              INDEX=0
              echo "{\"current_exercise\":\"${RANDOM_FILE}\",\"index\":${INDEX},\"start_time\":\"$(date -u +'%Y-%m-%d %H:%M:%S UTC')\"}" > "$STATE_FILE"
            fi
          fi

          FILE=$(jq -r .current_exercise "$STATE_FILE")
          INDEX=$(jq -r .index "$STATE_FILE")

          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "index=$INDEX" >> $GITHUB_OUTPUT

      - name: Post exercise line as issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          FILE="${{ steps.select.outputs.file }}"
          INDEX="${{ steps.select.outputs.index }}"
          LINE=$(sed -n "$((INDEX+1))p" "$FILE")

          # Extract first 6 words for the title
          SHORT_TITLE=$(echo "$LINE" | awk '{for(i=1;i<=6 && i<=NF;i++) printf "%s ", $i; if (NF>6) printf "..."}')

          USERS=("A.Arkin" "B.Pitt" "C.Theron" "D.Washington" "E.Wood")
          HOSTS=("BDP-SRV01" "TMX-LAP03" "ADS-MAIL02")
          IPS=("185.36.88.54" "92.143.21.100" "45.77.222.13")

          USER=${USERS[$RANDOM % ${#USERS[@]}]}
          HOST=${HOSTS[$RANDOM % ${#HOSTS[@]}]}
          IP=${IPS[$RANDOM % ${#IPS[@]}]}
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          TITLE="ðŸš¨ [${FILE}] ${SHORT_TITLE} - $TIMESTAMP"
          BODY=$(printf "**Exercise line %s from %s**\n\n%s\n\n**User:** %s\n**Host:** %s\n**IP:** %s\n" \
            "$((INDEX+1))" "$FILE" "$LINE" "$USER" "$HOST" "$IP")

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues" \
            -d "$(jq -nc --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b, labels:["Tabletop","Alert"]}')"

      - name: Update index and commit state
        run: |
          FILE="${{ steps.select.outputs.file }}"
          INDEX="${{ steps.select.outputs.index }}"
          NEXT=$((INDEX+1))
          jq --argjson i "$NEXT" '.index=$i' state.json > tmp.json && mv tmp.json state.json

          git add state.json
          git commit -m "Advance index to $NEXT for $FILE" || true
          git push origin main || true

      - name: Check if exercise finished and post summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          FILE=$(jq -r .current_exercise state.json)
          INDEX=$(jq -r .index state.json)
          TOTAL=$(wc -l < "$FILE" | tr -d ' ')
          if [ "$INDEX" -lt "$TOTAL" ]; then
            echo "Not finished ($INDEX / $TOTAL)"
            exit 0
          fi

          # Calculate duration based on state.json start_time
          START_TIME=$(jq -r .start_time state.json)
          END_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          START_EPOCH=$(date -d "$START_TIME" +%s 2>/dev/null || echo 0)
          END_EPOCH=$(date -d "$END_TIME" +%s 2>/dev/null || echo 0)
          if [ "$START_EPOCH" -gt 0 ] && [ "$END_EPOCH" -gt 0 ]; then
            DURATION_MIN=$(( (END_EPOCH - START_EPOCH) / 60 ))
          else
            DURATION_MIN="N/A"
          fi

          # Build summary with proper newlines
          {
            echo "### Completed Exercise File: $FILE"
            echo
            echo "**All lines processed:**"
            echo
            while IFS= read -r line; do
              echo "- ${line}"
            done < "$FILE"
            echo
            echo "**Duration:** $DURATION_MIN minutes (from first to last inject)"
          } > summary.txt

          TITLE="Summary - $FILE completed"
          BODY=$(cat summary.txt)

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues" \
            -d "$(jq -nc --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b, labels:["Tabletop","Summary"]}')"

          rm -f state.json
          git rm -f state.json || true
          git commit -m "Reset state after finishing $FILE" || true
          git push origin main || true
