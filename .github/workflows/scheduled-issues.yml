name: Tabletop Incident Injects (sequential per file)

on:
  schedule:
    - cron: "*/6 * * * *"   # every 6 minutes (free accounts reliable ~5-10min)
  workflow_dispatch:
    inputs:
      reset:
        description: "Reset -> pick a new random inject file"
        required: false
        type: choice
        options:
          - "false"
          - "true"
        default: "false"

# Optional feature to display how to run the injects
#      run_mode:
#        description: "Choose how to run the injects"
#        required: false
#        type: choice
#        options:
#         - "scheduled"
#          - "manual"
#       default: "scheduled"

permissions:
  contents: write
  issues: write

jobs:
  create-inject-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Ensure branch up-to-date
        env:
          BRANCH: ${{ github.ref_name }}
        run: |
          git fetch origin "$BRANCH"
          git checkout "$BRANCH"
          git reset --hard "origin/$BRANCH" || true
          git pull origin "$BRANCH" || true

      - name: Select or continue inject file
        id: select
        run: |
          set -euo pipefail
          RESET="${{ github.event.inputs.reset }}"
          echo "reset=$RESET"

          shopt -s nullglob
          files=(inject-*.txt)
          if [ ${#files[@]} -eq 0 ]; then
            echo "error=No inject-*.txt files found" >> $GITHUB_OUTPUT
            exit 1
          fi

          CUR_INJECT_FILE="current_inject.txt"
          CUR_INDEX_FILE="current_index.txt"
          START_TIME_FILE="inject_start_time.txt"

          PICK_NEW=false

          if [ "${RESET}" = "true" ]; then
            PICK_NEW=true
            echo "Manual reset requested"
          elif [ ! -f "$CUR_INJECT_FILE" ]; then
            PICK_NEW=true
            echo "No current_inject.txt found -> will pick random file"
          else
            CURRENT_FILE=$(cat "$CUR_INJECT_FILE")
            if [ ! -f "$CURRENT_FILE" ]; then
              PICK_NEW=true
              echo "Previous current file ($CURRENT_FILE) missing -> pick new"
            else
              INDEX=$(cat "$CUR_INDEX_FILE" 2>/dev/null || echo 0)
              TOTAL=$(wc -l < "$CURRENT_FILE" | tr -d ' ')
              if [ "$INDEX" -ge "$TOTAL" ]; then
                PICK_NEW=true
                echo "Previous current file finished -> will pick a new random file"
              else
                echo "Continuing with existing file: $CURRENT_FILE index=$INDEX total=$TOTAL"
              fi
            fi
          fi

          if [ "$PICK_NEW" = true ]; then
            RANDOM_FILE=${files[RANDOM % ${#files[@]}]}
            echo "$RANDOM_FILE" > "$CUR_INJECT_FILE"
            echo "0" > "$CUR_INDEX_FILE"
            date -u +'%Y-%m-%d %H:%M:%S UTC' > "$START_TIME_FILE"
            echo "Picked new inject file: $RANDOM_FILE"
          fi

          SELECTED_FILE=$(cat "$CUR_INJECT_FILE")
          INDEX=$(cat "$CUR_INDEX_FILE" 2>/dev/null || echo 0)
          echo "file=$SELECTED_FILE" >> $GITHUB_OUTPUT
          echo "index=$INDEX" >> $GITHUB_OUTPUT

      - name: Read current inject line (and detect completion)
        id: read
        run: |
          set -euo pipefail
          FILE="${{ steps.select.outputs.file }}"
          INDEX="${{ steps.select.outputs.index }}"
          TOTAL=$(wc -l < "$FILE" | tr -d ' ')
          echo "file=$FILE index=$INDEX total=$TOTAL"

          if [ "$INDEX" -ge "$TOTAL" ]; then
            echo "complete=true" >> $GITHUB_OUTPUT
            echo "file=$FILE" >> $GITHUB_OUTPUT
            exit 0
          fi

          LINE_NUMBER=$((INDEX + 1))
          LINE=$(sed -n "${LINE_NUMBER}p" "$FILE" | sed 's/\r$//')
          echo "line=$LINE" >> $GITHUB_OUTPUT
          echo "line_number=$LINE_NUMBER" >> $GITHUB_OUTPUT
          echo "complete=false" >> $GITHUB_OUTPUT

      - name: Post one inject as an Issue
        if: steps.read.outputs.complete == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          FILE="${{ steps.read.outputs.file }}"
          LINE_NUMBER="${{ steps.read.outputs.line_number }}"
          LINE="${{ steps.read.outputs.line }}"
          BRANCH="${{ github.ref_name }}"

          TITLE="ðŸš¨ [${FILE}] Inject ${LINE_NUMBER}: ${LINE:0:60}"
          BODY="**Inject ${LINE_NUMBER} from ${FILE}**\n\n${LINE}\n\n_Please triage and respond following IR playbook._"

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues" \
            -d "$(jq -nc --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b, labels:["Summary"]}')"

          rm -f current_inject.txt current_index.txt inject_start_time.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add -A || true
          git commit -m "cleanup after completing ${FILE}" || true
          git push origin ${{ github.ref_name }} || true
