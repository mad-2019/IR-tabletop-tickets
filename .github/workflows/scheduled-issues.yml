name: Tabletop Incident Injects

on:
  schedule:
    - cron: "*/6 * * * *"  # Every 6 minutes
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  issues: write

jobs:
  create_alert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Select or reuse inject file
        id: select_inject_file
        run: |
          CURRENT_FILE=".github/current_inject.txt"
          INJECT_FILES=(inject*.txt)
          
          # If manual run, always pick a random inject file
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RANDOM_FILE=${INJECT_FILES[$RANDOM % ${#INJECT_FILES[@]}]}
            echo "$RANDOM_FILE" > "$CURRENT_FILE"
            echo "Manually started. Selected inject file: $RANDOM_FILE"
          fi
          
          # Otherwise, reuse the current inject file
          if [ -f "$CURRENT_FILE" ]; then
            SELECTED_FILE=$(cat "$CURRENT_FILE")
          else
            SELECTED_FILE=${INJECT_FILES[$RANDOM % ${#INJECT_FILES[@]}]}
            echo "$SELECTED_FILE" > "$CURRENT_FILE"
          fi

          echo "inject_file=$SELECTED_FILE" >> $GITHUB_OUTPUT

      - name: Read and advance inject index
        id: read_inject
        run: |
          INDEX_FILE=".github/current_index.txt"
          INJECT_FILE="${{ steps.select_inject_file.outputs.inject_file }}"

          mapfile -t injects < "$INJECT_FILE"
          TOTAL=${#injects[@]}

          if [ -f "$INDEX_FILE" ]; then
            INDEX=$(cat "$INDEX_FILE")
          else
            INDEX=0
          fi

          # Stop automatically if end of file reached
          if [ "$INDEX" -ge "$TOTAL" ]; then
            echo "Reached end of $INJECT_FILE. Workflow will stop."
            exit 0
          fi

          INJECT="${injects[$INDEX]}"
          echo "inject=$INJECT" >> $GITHUB_OUTPUT
          echo "Current index: $INDEX of $TOTAL"

          # Increment index for next run
          NEXT_INDEX=$((INDEX + 1))
          echo "$NEXT_INDEX" > "$INDEX_FILE"

          # Commit index update silently
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "$INDEX_FILE"
          git commit -m "Advance inject index to $NEXT_INDEX" || echo "No changes to commit"
          git push || echo "No push done"

      - name: Create GitHub Issue via API
        if: steps.read_inject.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          INJECT: ${{ steps.read_inject.outputs.inject }}
        run: |
          USERS=("A.Arkin" "A.Jolie" "B.Pitt" "C.Theron" "D.Washington" "E.Wood" "H.Ford" "I.Elba" "J.Aniston" "J.Lawrence" "K.Reeves" "L.DiCaprio" "M.Robbie" "N.Portman" "O.Wilson" "P.Stewart" "Q.Tarantino" "R.Gosling" "S.L.Jackson" "W.Ferrell")
          HOSTS=("BDP-SRV01" "TMX-LAP03" "TMSR-WS12" "TMCSE-AD01" "ADS-MAIL02" "TGMT-FW01" "TMCS-SQL03")
          IPS=("185.36.88.54" "92.143.21.100" "10.0.12.5" "172.16.8.9" "45.77.222.13" "212.58.124.5")

          USER=${USERS[$RANDOM % ${#USERS[@]}]}
          HOST=${HOSTS[$RANDOM % ${#HOSTS[@]}]}
          IP=${IPS[$RANDOM % ${#IPS[@]}]}
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          TITLE="ðŸš¨ Security Alert - ${TIMESTAMP}"

          BODY="{\"title\":\"${TITLE}\",\"body\":\"**Incident:** ${INJECT}\n\n**Detected by:** SOC Monitoring\n**User:** ${USER}\n**Host:** ${HOST}\n**Source IP:** ${IP}\n**Timestamp:** ${TIMESTAMP}\",\"labels\":[\"Tabletop\",\"Alert\"]}"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -d "$BODY" \
            "https://api.github.com/repos/${REPO}/issues"
