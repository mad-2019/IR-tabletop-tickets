name: Tabletop Incident Injects

on:
  schedule:
    - cron: "*/6 * * * *"
  workflow_dispatch:

permissions:
  contents: write        # âœ… give push permission
  issues: write

jobs:
  create_alert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true   # âœ… keep push credentials

      - name: Initialize or read current index
        id: index
        run: |
          INDEX_FILE=".github/workflows/current_index.txt"
          if [ ! -f "$INDEX_FILE" ]; then
            echo "1" > "$INDEX_FILE"
          fi
          INDEX=$(cat "$INDEX_FILE")
          echo "Current index: $INDEX"
          echo "index=$INDEX" >> $GITHUB_OUTPUT

      - name: Read inject list
        id: read_injects
        run: |
          if [ -f "injects.txt" ]; then
            mapfile -t injects < injects.txt
          else
            injects=("Suspicious login from admin account"
                     "Privilege escalation detected on web server"
                     "Email gateway reports phishing with attachment"
                     "Crowdstrike Falcon quarantined suspicious file"
                     "Azure AD conditional access bypass was attempted"
                     "Firewall rule unexpectedly changed"
                     "Data exfiltration pattern detected in proxy logs"
                     "MFA disabled by administrator account"
                     "Multiple failed logins detected from high risk country IP")
          fi

          INDEX=${{ steps.index.outputs.index }}
          COUNT=${#injects[@]}
          if [ "$INDEX" -gt "$COUNT" ]; then
            echo "No more injects left (reached $INDEX / $COUNT)"
            exit 0
          fi

          inject="${injects[$((INDEX-1))]}"
          echo "inject=$inject" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          INJECT: ${{ steps.read_injects.outputs.inject }}
          INDEX: ${{ steps.index.outputs.index }}
        run: |
          USERS=("A.Arkin" "A.Jolie" "B.Pitt" "C.Theron" "D.Washington" "E.Wood" "H.Ford" "I.Elba" "J.Aniston" "J.Lawrence" "K.Reeves" "L.DiCaprio" "M.Robbie" "N.Portman" "O.Wilson" "P.Stewart" "Q.Tarantino" "R.Gosling" "S.L.Jackson" "W.Ferrell")
          HOSTS=("BDP-SRV01" "TMX-LAP03" "TMSR-WS12" "TMCSE-AD01" "ADS-MAIL02" "TGMT-FW01" "TMCS-SQL03")
          IPS=("185.36.88.54" "92.143.21.100" "10.0.12.5" "172.16.8.9" "45.77.222.13" "212.58.124.5")

          USER=${USERS[$RANDOM % ${#USERS[@]}]}
          HOST=${HOSTS[$RANDOM % ${#HOSTS[@]}]}
          IP=${IPS[$RANDOM % ${#IPS[@]}]}
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          TITLE="ðŸš¨ Security Alert #${INDEX} - ${TIMESTAMP}"
          BODY="{\"title\":\"${TITLE}\",\"body\":\"**Incident:** ${INJECT}\n\n**Detected by:** SOC Monitoring\n**User:** ${USER}\n**Host:** ${HOST}\n**Source IP:** ${IP}\n**Timestamp:** ${TIMESTAMP}\n\n_Please triage and respond following IR playbook._\",\"labels\":[\"Tabletop\",\"Alert\"]}"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -d "$BODY" \
            "https://api.github.com/repos/${REPO}/issues"

      - name: Increment index
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          INDEX_FILE=".github/workflows/current_index.txt"
          INDEX=$(cat "$INDEX_FILE")
          NEXT=$((INDEX + 1))
          echo "$NEXT" > "$INDEX_FILE"

          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "$INDEX_FILE"
          git commit -m "Increment inject index to $NEXT" || echo "No changes"
          git push

