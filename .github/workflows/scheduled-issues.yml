name: Tabletop Incident Injects

on:
  schedule:
    - cron: "*/6 * * * *"
  workflow_dispatch:
    inputs:
      reset:
        description: "Start a new random inject? (true = new, false = continue)"
        required: true
        type: choice
        options: ["false","true"]
        default: "true"

permissions:
  contents: write
  issues: write

jobs:
  injects:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true

      - name: Select or continue inject file
        id: select
        run: |
          set -euo pipefail
          RESET="${{ github.event.inputs.reset }}"
          CUR_INJECT_FILE="current_inject.txt"
          CUR_INDEX_FILE="current_index.txt"
          START_TIME_FILE="inject_start_time.txt"

          shopt -s nullglob
          files=(inject-*.txt)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No inject-*.txt files present" >&2
            exit 1
          fi

          PICK_NEW=false
          if [ "$RESET" = "true" ]; then
            PICK_NEW=true
          elif [ ! -f "$CUR_INJECT_FILE" ] || [ ! -f "$CUR_INDEX_FILE" ]; then
            PICK_NEW=true
          else
            INDEX=$(cat "$CUR_INDEX_FILE")
            CURRENT_FILE=$(cat "$CUR_INJECT_FILE")
            TOTAL=$(wc -l < "$CURRENT_FILE" | tr -d ' ')
            if [ "$INDEX" -ge "$TOTAL" ]; then
              PICK_NEW=true
            fi
          fi

          if [ "$PICK_NEW" = true ]; then
            RANDOM_FILE=${files[RANDOM % ${#files[@]}]}
            echo "$RANDOM_FILE" > "$CUR_INJECT_FILE"
            echo "0" > "$CUR_INDEX_FILE"
            date -u +'%Y-%m-%d %H:%M:%S UTC' > "$START_TIME_FILE"
            echo "Picked new inject: $RANDOM_FILE"
          else
            echo "Continuing with existing inject $(cat $CUR_INJECT_FILE)"
          fi

          FILE=$(cat "$CUR_INJECT_FILE")
          INDEX=$(cat "$CUR_INDEX_FILE")
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "index=$INDEX" >> $GITHUB_OUTPUT

      - name: Post one inject as issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          FILE="${{ steps.select.outputs.file }}"
          INDEX="${{ steps.select.outputs.index }}"
          LINE=$(sed -n "$((INDEX+1))p" "$FILE")

          USERS=("A.Arkin" "B.Pitt" "C.Theron")
          HOSTS=("BDP-SRV01" "TMX-LAP03" "ADS-MAIL02")
          IPS=("185.36.88.54" "92.143.21.100" "45.77.222.13")
          USER=${USERS[$RANDOM % ${#USERS[@]}]}
          HOST=${HOSTS[$RANDOM % ${#HOSTS[@]}]}
          IP=${IPS[$RANDOM % ${#IPS[@]}]}
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          TITLE="ðŸš¨ [${FILE}] Line $((INDEX+1)) - $TIMESTAMP"
          BODY=$(printf "**Inject %s from %s**\n\n%s\n\n**User:** %s\n**Host:** %s\n**IP:** %s\n" \
            "$((INDEX+1))" "$FILE" "$LINE" "$USER" "$HOST" "$IP")

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues" \
            -d "$(jq -nc --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b, labels:["Tabletop","Alert"]}')"

          echo $((INDEX+1)) > current_index.txt
          git add current_index.txt
          git commit -m "Advance index to $((INDEX+1)) for $FILE" || true
          git push origin main || true

      - name: If finished, post summary and cleanup
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          FILE=$(cat current_inject.txt)
          INDEX=$(cat current_index.txt)
          TOTAL=$(wc -l < "$FILE" | tr -d ' ')
          if [ "$INDEX" -lt "$TOTAL" ]; then
            echo "Not finished ($INDEX/$TOTAL)."
            exit 0
          fi

          START=$(cat inject_start_time.txt)
          END=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          DURATION=$(( ($(date -d "$END" +%s) - $(date -d "$START" +%s)) / 60 ))

          SUMMARY="### Completed Inject File: $FILE\n\n**Start:** $START\n**End:** $END\n**Duration:** $DURATION minutes\n\n**All lines:**\n"
          while IFS= read -r line; do
            SUMMARY="${SUMMARY}\n- ${line}"
          done < "$FILE"

          TITLE="Summary - $FILE completed"
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues" \
            -d "$(jq -nc --arg t "$TITLE" --arg b "$SUMMARY" '{title:$t, body:$b, labels:["Tabletop","Summary"]}')"

          rm -f current_inject.txt current_index.txt inject_start_time.txt
          git add -A
          git commit -m "Cleanup after $FILE finished" || true
          git push origin main || true
