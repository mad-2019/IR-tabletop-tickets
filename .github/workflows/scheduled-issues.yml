name: Tabletop Incident Injects

on:
  schedule:
    - cron: "*/6 * * * *"  # Every 6 minutes
  workflow_dispatch:
    inputs:
      reset:
        description: "Reset to a new random inject file"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  issues: write

jobs:
  create_alert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0   # <-- FIX: allows reading latest commits from previous runs

      - name: Pull latest commits
        run: |
          git fetch origin main
          git checkout main
          git pull origin main

      - name: Select or reuse inject file
        id: select_inject_file
        run: |
          CURRENT_FILE=".github/current_inject.txt"
          INDEX_FILE=".github/current_index.txt"
          INJECT_FILES=(inject*.txt)

          PICK_NEW=false
          RESET_INPUT="${{ github.event.inputs.reset }}"

          # Manual reset
          if [ "$RESET_INPUT" = "true" ]; then
            PICK_NEW=true
            echo "Manual reset requested."
          elif [ ! -f "$CURRENT_FILE" ]; then
            PICK_NEW=true
            echo "No current inject file found."
          elif [ -f "$INDEX_FILE" ] && [ -f "$CURRENT_FILE" ]; then
            SELECTED_FILE=$(cat "$CURRENT_FILE")
            mapfile -t injects < "$SELECTED_FILE"
            TOTAL=${#injects[@]}
            INDEX=$(cat "$INDEX_FILE" 2>/dev/null || echo 0)
            if [ "$INDEX" -ge "$TOTAL" ]; then
              PICK_NEW=true
              echo "Finished previous inject file, picking a new one."
            fi
          fi

          if [ "$PICK_NEW" = true ]; then
            RANDOM_FILE=${INJECT_FILES[$RANDOM % ${#INJECT_FILES[@]}]}
            echo "$RANDOM_FILE" > "$CURRENT_FILE"
            echo 0 > "$INDEX_FILE"
            echo "Selected new inject file: $RANDOM_FILE"
          fi

          SELECTED_FILE=$(cat "$CURRENT_FILE")
          echo "inject_file=$SELECTED_FILE" >> $GITHUB_OUTPUT

      - name: Read and advance inject index
        id: read_inject
        run: |
          INDEX_FILE=".github/current_index.txt"
          INJECT_FILE="${{ steps.select_inject_file.outputs.inject_file }}"

          mapfile -t injects < "$INJECT_FILE"
          TOTAL=${#injects[@]}

          if [ -f "$INDEX_FILE" ]; then
            INDEX=$(cat "$INDEX_FILE")
          else
            INDEX=0
          fi

          if [ "$INDEX" -ge "$TOTAL" ]; then
            echo "Reached end of inject file â€” posting summary issue."
            
            GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
            REPO="${{ github.repository }}"
            TITLE="âœ… Completed Inject File: $(basename $INJECT_FILE)"

            BODY="The inject file **$(basename $INJECT_FILE)** has been fully processed.\n\n**Total Injects:** $TOTAL\n\n### Injects Completed:\n"
            for i in "${injects[@]}"; do
              BODY="${BODY}- ${i}\n"
            done

            BODY="${BODY}\nThe next random inject file will be selected on the next manual or scheduled run."

            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -d "{\"title\":\"${TITLE}\",\"body\":\"${BODY}\",\"labels\":[\"Summary\"]}" \
              "https://api.github.com/repos/${REPO}/issues"

            exit 0
          fi

          INJECT="${injects[$INDEX]}"
          echo "inject=$INJECT" >> $GITHUB_OUTPUT
          echo "Current index: $INDEX of $TOTAL"

          NEXT_INDEX=$((INDEX + 1))
          echo "$NEXT_INDEX" > "$INDEX_FILE"

          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "$INDEX_FILE"
          git commit -m "Advance inject index to $NEXT_INDEX" || echo "No changes to commit"
          git push origin main || echo "No push done"

      - name: Create GitHub Issue via API
        if: steps.read_inject.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          INJECT: ${{ steps.read_inject.outputs.inject }}
          FILE_USED: ${{ steps.select_inject_file.outputs.inject_file }}
        run: |
          USERS=("A.Arkin" "A.Jolie" "B.Pitt" "C.Theron" "D.Washington" "E.Wood" "H.Ford" "I.Elba" "J.Aniston" "J.Lawrence" "K.Reeves" "L.DiCaprio" "M.Robbie" "N.Portman" "O.Wilson" "P.Stewart" "Q.Tarantino" "R.Gosling" "S.L.Jackson" "W.Ferrell")
          HOSTS=("BDP-SRV01" "TMX-LAP03" "TMSR-WS12" "TMCSE-AD01" "ADS-MAIL02" "TGMT-FW01" "TMCS-SQL03")
          IPS=("185.36.88.54" "92.143.21.100" "10.0.12.5" "172.16.8.9" "45.77.222.13" "212.58.124.5")

          USER=${USERS[$RANDOM % ${#USERS[@]}]}
          HOST=${HOSTS[$RANDOM % ${#HOSTS[@]}]}
          IP=${IPS[$RANDOM % ${#IPS[@]}]}
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          TITLE="ðŸš¨ [$(basename $FILE_USED)] Security Alert - ${TIMESTAMP}"

          BODY="{\"title\":\"${TITLE}\",\"body\":\"**Incident:** ${INJECT}\n\n**Detected by:** SOC Monitoring\n**User:** ${USER}\n**Host:** ${HOST}\n**Source IP:** ${IP}\n**Timestamp:** ${TIMESTAMP}\",\"labels\":[\"Tabletop\",\"Alert\"]}"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -d "$BODY" \
            "https://api.github.com/repos/${REPO}/issues"
