name: Tabletop Incident Injects

on:
  schedule:
    - cron: "*/6 * * * *"  # Every 6 minutes (minimum for free accounts)
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write   # âœ… Needed to commit index file
  issues: write

jobs:
  create_alert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # âœ… Needed to push commits
          fetch-depth: 0

      - name: Read inject list
        id: read_injects
        run: |
          if [ -f "injects.txt" ]; then
            mapfile -t injects < injects.txt
          else
            injects=("Suspicious login from admin account"
                     "Privilege escalation detected on web server"
                     "Email gateway reports phishing with attachment"
                     "Crowdstrike Falcon quarantined suspicious file"
                     "Azure AD conditional access bypass was attempted"
                     "Firewall rule unexpectedly changed"
                     "Data exfiltration pattern detected in proxy logs"
                     "MFA disabled by administrator account"
                     "Multiple failed logins detected from high risk country IP")
          fi

          INDEX_FILE="current_index.txt"  # Store index in repo root
          if [ ! -f "$INDEX_FILE" ]; then
            echo 0 > "$INDEX_FILE"
          fi

          INDEX=$(cat "$INDEX_FILE")

          # Wrap around if end of inject list reached
          if [ $INDEX -ge ${#injects[@]} ]; then
            INDEX=0
          fi

          INJECT="${injects[$INDEX]}"
          echo "inject=$INJECT" >> $GITHUB_OUTPUT
          echo "index=$INDEX" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          INJECT: ${{ steps.read_injects.outputs.inject }}
        run: |
          USERS=("A.Arkin" "A.Jolie" "B.Pitt" "C.Theron" "D.Washington" "E.Wood" "H.Ford" "I.Elba" "J.Aniston" "J.Lawrence" "K.Reeves" "L.DiCaprio" "M.Robbie" "N.Portman" "O.Wilson" "P.Stewart" "Q.Tarantino" "R.Gosling" "S.L.Jackson" "W.Ferrell")
          HOSTS=("BDP-SRV01" "TMX-LAP03" "TMSR-WS12" "TMCSE-AD01" "ADS-MAIL02" "TGMT-FW01" "TMCS-SQL03")
          IPS=("185.36.88.54" "92.143.21.100" "10.0.12.5" "172.16.8.9" "45.77.222.13" "212.58.124.5")

          USER=${USERS[$RANDOM % ${#USERS[@]}]}
          HOST=${HOSTS[$RANDOM % ${#HOSTS[@]}]}
          IP=${IPS[$RANDOM % ${#IPS[@]}]}
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          RAND=$((RANDOM % 10000))

          TITLE="ðŸš¨ Security Alert #${RAND} - ${TIMESTAMP}"
          BODY="{\"title\":\"${TITLE}\",\"body\":\"**Incident:** ${INJECT}\n\n**Detected by:** SOC Monitoring\n**User:** ${USER}\n**Host:** ${HOST}\n**Source IP:** ${IP}\n**Timestamp:** ${TIMESTAMP}\n\n_Please triage and respond following IR playbook._\",\"labels\":[\"Tabletop\",\"Alert\"]}"

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -d "$BODY" \
            "https://api.github.com/repos/${REPO}/issues"

      - name: Increment Index
        run: |
          INDEX_FILE="current_index.txt"
          if [ ! -f "$INDEX_FILE" ]; then
            echo 0 > "$INDEX_FILE"
          fi

          INDEX=$(cat "$INDEX_FILE")
          NEXT_INDEX=$((INDEX + 1))

          # Reset automatically if beyond last inject
          TOTAL_INJECTS=$(wc -l < injects.txt 2>/dev/null || echo 9)
          if [ $NEXT_INDEX -ge $TOTAL_INJECTS ]; then
            NEXT_INDEX=0
          fi

          echo $NEXT_INDEX > "$INDEX_FILE"
          echo "Updated inject index to $NEXT_INDEX"

          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "$INDEX_FILE"
          git commit -m "Increment inject index to $NEXT_INDEX" || echo "No changes to commit"
          git push

