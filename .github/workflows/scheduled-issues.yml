name: Tabletop Incident Injects

on:
  schedule:
    - cron: "*/6 * * * *"  # Every 6 minutes as minimum for free account
  workflow_dispatch:
    inputs:
      reset:
        description: "Start a new random inject? (true = new, false = continue)"
        required: true
        default: "true"

permissions:
  contents: write  # needed to commit index files
  issues: write

jobs:
  create_alert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------
      # COMMENTED OUT run_mode input as per request
      # run_mode:
      #   description: "Choose how to run the injects"
      #   required: false
      #   type: choice
      #   options:
      #     - "scheduled"
      #     - "manual"
      #   default: "scheduled"
      # -------------------------------------------------------------

      - name: Select or continue inject file
        id: select
        run: |
          set -euo pipefail

          RESET="${{ github.event.inputs.reset }}"
          echo "reset=$RESET"

          # collect all inject-X.txt files
          shopt -s nullglob
          files=(inject-*.txt)
          if [ ${#files[@]} -eq 0 ]; then
            echo "error=No inject-*.txt files found" >> $GITHUB_OUTPUT
            exit 1
          fi

          CUR_INJECT_FILE="current_inject.txt"
          CUR_INDEX_FILE="current_index.txt"
          START_TIME_FILE="inject_start_time.txt"

          PICK_NEW=false

          # decide if we need a new inject
          if [ "${RESET}" = "true" ]; then
            PICK_NEW=true
            echo "Manual reset requested"
          elif [ ! -f "$CUR_INJECT_FILE" ] || [ ! -f "$CUR_INDEX_FILE" ]; then
            PICK_NEW=true
            echo "Missing current inject files -> pick new"
          else
            INDEX=$(cat "$CUR_INDEX_FILE")
            TOTAL=$(wc -l < "$CUR_INJECT_FILE" | tr -d ' ')
            if [ "$INDEX" -ge "$TOTAL" ]; then
              PICK_NEW=true
              echo "Previous inject finished -> pick new"
            else
              PICK_NEW=false
              echo "Continuing with existing inject: $(cat $CUR_INJECT_FILE) line $INDEX"
            fi
          fi

          # pick a random inject if needed
          if [ "$PICK_NEW" = true ]; then
            RANDOM_FILE=${files[RANDOM % ${#files[@]}]}
            echo "$RANDOM_FILE" > "$CUR_INJECT_FILE"
            echo "0" > "$CUR_INDEX_FILE"
            date -u +'%Y-%m-%d %H:%M:%S UTC' > "$START_TIME_FILE"
            echo "Picked new inject file: $RANDOM_FILE"
          fi

          SELECTED_FILE=$(cat "$CUR_INJECT_FILE")
          INDEX=$(cat "$CUR_INDEX_FILE")
          echo "file=$SELECTED_FILE" >> $GITHUB_OUTPUT
          echo "index=$INDEX" >> $GITHUB_OUTPUT

      - name: Read current line
        id: read_line
        run: |
          FILE="${{ steps.select.outputs.file }}"
          INDEX="${{ steps.select.outputs.index }}"

          LINE=$(sed -n "$((INDEX+1))p" "$FILE")
          echo "line=$LINE" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          INJECT: ${{ steps.read_line.outputs.line }}
          FILE: ${{ steps.select.outputs.file }}
          INDEX: ${{ steps.select.outputs.index }}
        run: |
          set -euo pipefail

          # fake details
          USERS=("A.Arkin" "A.Jolie" "B.Pitt" "C.Theron" "D.Washington" "E.Wood" "H.Ford" "I.Elba" "J.Aniston" "J.Lawrence" "K.Reeves" "L.DiCaprio" "M.Robbie" "N.Portman" "O.Wilson" "P.Stewart" "Q.Tarantino" "R.Gosling" "S.L.Jackson" "W.Ferrell")
          HOSTS=("BDP-SRV01" "TMX-LAP03" "TMSR-WS12" "TMCSE-AD01" "ADS-MAIL02" "TGMT-FW01" "TMCS-SQL03")
          IPS=("185.36.88.54" "92.143.21.100" "10.0.12.5" "172.16.8.9" "45.77.222.13" "212.58.124.5")

          USER=${USERS[$RANDOM % ${#USERS[@]}]}
          HOST=${HOSTS[$RANDOM % ${#HOSTS[@]}]}
          IP=${IPS[$RANDOM % ${#IPS[@]}]}
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          RAND=$((RANDOM % 10000))

          TITLE="ðŸš¨ Security Alert #${RAND} - ${TIMESTAMP}"

          BODY="**Inject $((INDEX+1)) from $FILE**"$'\n\n'"${INJECT}"$'\n\n**Detected by:** SOC Monitoring\n**User:** ${USER}\n**Host:** ${HOST}\n**Source IP:** ${IP}\n**Timestamp:** ${TIMESTAMP}\n\n_Please triage and respond following IR playbook._"

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues" \
            -d "$(jq -nc --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b, labels:["Tabletop","Alert"]}')"

      - name: Increment inject index
        run: |
          FILE="${{ steps.select.outputs.file }}"
          INDEX="${{ steps.select.outputs.index }}"
          NEXT=$((INDEX+1))
          echo "$NEXT" > current_index.txt

          # commit index file so next run continues same inject
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add current_index.txt
          git commit -m "Increment inject index to $NEXT"
          git push

      - name: Check if inject finished and post summary
        if: ${{ steps.select.outputs.index == (steps.select.outputs.index) }} # placeholder
        run: |
          FILE="${{ steps.select.outputs.file }}"
          INDEX=$(cat current_index.txt)
          TOTAL=$(wc -l < "$FILE" | tr -d ' ')
          if [ "$INDEX" -ge "$TOTAL" ]; then
            END_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
            START_TIME=$(cat inject_start_time.txt)
            DURATION=$(( $(date -d "$END_TIME" +%s) - $(date -d "$START_TIME" +%s) ))
            DURATION_MIN=$((DURATION / 60))

            BODY="### Completed Inject File: ${FILE}"$'\n\n'
            BODY+="**Start:** ${START_TIME}"$'\n'
            BODY+="**End:** ${END_TIME}"$'\n'
            BODY+="**Duration:** ${DURATION_MIN} minutes"$'\n\n'
            BODY+="**All injects processed:**"$'\n\n'
            while IFS= read -r line; do
              BODY+="- ${line}"$'\n'
            done < "$FILE"

            TITLE="Summary - ${FILE} completed"

            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${REPO}/issues" \
              -d "$(jq -nc --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b, labels:["Tabletop","Summary"]}')"

            # cleanup files so next run picks new random inject
            rm -f current_index.txt current_inject.txt inject_start_time.txt
